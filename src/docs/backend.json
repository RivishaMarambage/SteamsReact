{
  "entities": {
    "MenuItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MenuItem",
      "type": "object",
      "description": "Represents an item on the cafe's menu.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the menu item."
        },
        "name": {
          "type": "string",
          "description": "Name of the menu item."
        },
        "description": {
          "type": "string",
          "description": "Description of the menu item."
        },
        "price": {
          "type": "number",
          "description": "Price of the menu item."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "price"
      ]
    },
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Represents an order placed by a customer for pickup.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the order."
        },
        "customerId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Order)"
        },
        "orderDate": {
          "type": "string",
          "description": "Date and time the order was placed.",
          "format": "date-time"
        },
        "totalAmount": {
          "type": "number",
          "description": "Total amount of the order."
        },
        "status": {
          "type": "string",
          "description": "Status of the order (e.g., pending, processing, ready for pickup, completed)."
        },
        "orderItemIds": {
          "type": "array",
          "description": "References to OrderItem. (Relationship: Order 1:N OrderItem)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "customerId",
        "orderDate",
        "totalAmount",
        "status"
      ]
    },
    "OrderItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OrderItem",
      "type": "object",
      "description": "Represents a single item within an order.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the order item."
        },
        "orderId": {
          "type": "string",
          "description": "Reference to Order. (Relationship: Order 1:N OrderItem)"
        },
        "menuItemId": {
          "type": "string",
          "description": "Reference to MenuItem. (Relationship: MenuItem 1:N OrderItem)"
        },
        "quantity": {
          "type": "number",
          "description": "Quantity of the menu item in the order."
        },
        "itemPrice": {
          "type": "number",
          "description": "Price of the item for this order.  Useful if prices change."
        }
      },
      "required": [
        "id",
        "orderId",
        "menuItemId",
        "quantity",
        "itemPrice"
      ]
    },
    "LoyaltyLevel": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "LoyaltyLevel",
      "type": "object",
      "description": "Represents a loyalty level in the system (e.g., Bronze, Silver, Gold, Platinum).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the loyalty level."
        },
        "name": {
          "type": "string",
          "description": "Name of the loyalty level (e.g., Bronze, Silver, Gold, Platinum)."
        },
        "minimumPoints": {
          "type": "number",
          "description": "Minimum number of points required to reach this loyalty level."
        },
        "discountPercentage": {
          "type": "number",
          "description": "The discount percentage that this loyalty level gives"
        }
      },
      "required": [
        "id",
        "name",
        "minimumPoints",
        "discountPercentage"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the system (customer, staff, admin), containing their profile information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user, matching their Firebase Auth UID."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "User's role.",
          "enum": ["customer", "staff", "admin"]
        },
        "mobileNumber": {
          "type": "string",
          "description": "User's mobile number (if they are a customer)."
        },
        "name": {
          "type": "string",
          "description": "User's full name."
        },
        "cafeNickname": {
          "type": "string",
          "description": "User's preferred nickname for the cafe (if they are a customer)."
        },
        "loyaltyPoints": {
          "type": "number",
          "description": "The number of loyalty points the user has (if they are a customer)."
        },
        "loyaltyLevelId": {
          "type": "string",
          "description": "The user's current loyalty level ID (if they are a customer)."
        }
      },
      "required": [
        "id",
        "email",
        "role",
        "name"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores all user data, including role and profile information. This unified document simplifies data access and security rules.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user, matching their Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/menu_items/{menuItemId}",
        "definition": {
          "entityName": "MenuItem",
          "schema": {
            "$ref": "#/backend/entities/MenuItem"
          },
          "description": "Stores menu item information. Globally accessible (read-only for customers).",
          "params": [
            {
              "name": "menuItemId",
              "description": "The unique identifier for the menu item."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores orders placed by customers. Accessible by the customer who placed the order and authorized staff/admins. Path-based ownership for security.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user (customer)."
            },
            {
              "name": "orderId",
              "description": "The unique identifier for the order."
            }
          ]
        }
      },
      {
        "path": "/orders_items/{orderItemId}",
        "definition": {
          "entityName": "OrderItem",
          "schema": {
            "$ref": "#/backend/entities/OrderItem"
          },
          "description": "Stores order items.  This is a flat collection to simplify querying and listing order items regardless of user. Includes denormalized customer ID for rule simplicity.",
          "params": [
            {
              "name": "orderItemId",
              "description": "The unique identifier for the order item."
            }
          ]
        }
      },
      {
        "path": "/loyalty_levels/{loyaltyLevelId}",
        "definition": {
          "entityName": "LoyaltyLevel",
          "schema": {
            "$ref": "#/backend/entities/LoyaltyLevel"
          },
          "description": "Stores loyalty level definitions. Globally accessible (read-only).",
          "params": [
            {
              "name": "loyaltyLevelId",
              "description": "The unique identifier for the loyalty level."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Indicates admin role. Existence of document grants admin privileges. Content is minimal.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user with admin role."
            }
          ]
        }
      },
      {
        "path": "/roles_staff/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Indicates staff role. Existence of document grants staff privileges. Content is minimal.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user with staff role."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure has been simplified by merging the `CustomerProfile` entity into the `User` entity. This creates a single, unified `/users/{userId}` collection that serves as the source of truth for all user-related information, including their role, profile data, and loyalty status. This eliminates the need for the separate `/customer_profiles` collection and complex `get()` calls in security rules, which was a primary source of permission errors.\n\n**Role-Based Access Control:** Role management remains explicit and secure. Admin and staff roles are granted by the existence of documents in the `/roles_admin/{userId}` and `/roles_staff/{userId}` collections, respectively. This is a secure pattern that is now correctly implemented in the client-side code."
  }
}
    