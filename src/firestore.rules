/**
 * Core Philosophy: This ruleset enforces a strict Role-Based Access Control (RBAC) model
 * for a Cafe Loyalty System. There are three primary roles: 'admin', 'staff', and 'customer'.
 * This version uses a simplified data model where all user information is stored in a single
 * `/users/{userId}` document.
 *
 * Data Structure:
 * - /users/{userId}: A unified document for each user, containing their role, profile, and loyalty info.
 * - /users/{userId}/orders/{orderId}: User-specific orders are nested, enforcing a clear ownership model.
 * - /roles_admin/{userId}, /roles_staff/{userId}: Role management is handled via dedicated lookup
 *   collections. The existence of a document in these collections grants the corresponding role.
 * - /menu_items, /loyalty_levels: Publicly readable collections managed by staff and admins.
 *
 * Key Security Decisions:
 * - Unified User Document: Merging customer profile data into the `users` collection simplifies rules significantly.
 *   There is no longer a need for a cross-collection `get()` to check for profile ownership, which resolves
 *   the previous permission errors.
 * - Role Source of Truth: Admin and Staff roles are determined by the existence of a document in
 *   /roles_admin/{userId} and /roles_staff/{userId} respectively. This is a secure and performant pattern.
 * - Disallowed Listing: Listing all users is strictly forbidden to protect user privacy.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for concise and readable rules
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Role check: User is an admin if their UID exists in the roles_admin collection.
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // Role check: User is staff if their UID exists in the roles_staff collection.
    function isStaff() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_staff/$(request.auth.uid));
    }

    function isStaffOrAdmin() {
      return isAdmin() || isStaff();
    }
    
    /**
     * @description Manages unified user account documents, including profile data.
     * @path /users/{userId}
     * @allow A user can create, read, update, and delete their own user document. Admins/staff can read any user document.
     * @deny A user cannot list or access another user's document (unless they are staff/admin).
     * @principle Enforces self-management and ownership of a user's single source of truth.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isStaffOrAdmin();
      allow list: if false; // Prevent enumerating all users
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Publicly readable menu items. Only staff and admins can modify the menu.
     * @path /menu_items/{menuItemId}
     */
    match /menu_items/{menuItemId} {
      allow read: if true;
      allow write: if isStaffOrAdmin();
    }

    /**
     * @description Customer orders, nested under the user's path for clear ownership.
     * @path /users/{userId}/orders/{orderId}
     */
    match /users/{userId}/orders/{orderId} {
      allow get, list: if isOwner(userId) || isStaffOrAdmin();
      allow create: if isOwner(userId) && request.resource.data.customerId == userId;
      allow update, delete: if isOwner(userId) || isStaffOrAdmin();
    }

    /**
     * @description Individual items within an order. Assumes a denormalized `customerId` for security.
     * @path /orders_items/{orderItemId}
     */
    match /orders_items/{orderItemId} {
      allow get: if isStaffOrAdmin() || (isSignedIn() && resource.data.customerId == request.auth.uid);
      allow list: if false; // Prevent listing all order items
      allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
      allow update, delete: if (isStaffOrAdmin() || (isSignedIn() && resource.data.customerId == request.auth.uid));
    }

    /**
     * @description Publicly readable loyalty levels. Only admins can define these levels.
     * @path /loyalty_levels/{loyaltyLevelId}
     */
    match /loyalty_levels/{loyaltyLevelId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Grants admin privileges. Existence of a document here makes a user an admin.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      // A user should be able to check if they are an admin.
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      // The first admin can create their own role. Subsequent admins must be created by existing admins.
      allow create: if isAdmin() || (isOwner(userId) && !exists(/databases/$(database)/documents/roles_admin));
      allow write: if isAdmin();
    }

    /**
     * @description Grants staff privileges. Existence of a document here makes a user staff.
     * @path /roles_staff/{userId}
     */
    match /roles_staff/{userId} {
      // A user should be able to check if they are staff. Admins can also check.
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow write: if isAdmin();
    }
  }
}

    